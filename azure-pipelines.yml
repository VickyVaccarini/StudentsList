trigger:
- main

pr:
- main

pool:
  vmImage: ubuntu-latest

variables:
- name: serviceConnection
  value: ServiceConnectionARM
- name: resourceGroup
  value: finalStudents
- name: backendAppQa
  value: students-back-qa
- name: backendAppProd
  value: students-back-prod
- name: frontendAppQa
  value: students-front-qa
- name: frontendAppProd
  value: students-front-prod
- name: backendQaUrl
  value: https://students-back-qa-cxa0evadgvggcehr.brazilsouth-01.azurewebsites.net/api/v1/students
- name: backendProdUrl
  value: https://students-back-prod-f4eucbcdbve3bwaz.brazilsouth-01.azurewebsites.net/api/v1/students
- name: javaVersion
  value: '17'
- name: nodeVersion
  value: '16.x'     # React Scripts 3.4.1 funciona con Node 16

stages:

# ===================================================
#   STAGE 1 - BUILD Y TESTS
# ===================================================
- stage: BuildAndTest
  displayName: "Build y tests"
  jobs:

    # -------- BACKEND --------
    - job: BuildBackend
      displayName: "Backend Maven"
      steps:
        - checkout: self

        - task: Maven@4
          displayName: "Tests backend"
          inputs:
            mavenPomFile: springboot-backend/pom.xml
            goals: clean test
            publishJUnitResults: true
            testResultsFiles: '**/target/surefire-reports/*.xml'
            jdkVersionOption: '1.17'

        - task: PublishCodeCoverageResults@2
          displayName: "Cobertura backend (JaCoCo)"
          inputs:
            codeCoverageTool: JaCoCo
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/springboot-backend/target/site/jacoco/jacoco.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/springboot-backend/target/site/jacoco'
            failIfCoverageEmpty: false

        - task: Maven@4
          displayName: "Empaquetar Backend (sin tests)"
          inputs:
            mavenPomFile: springboot-backend/pom.xml
            goals: package -DskipTests
            jdkVersionOption: '1.17'

        - task: PublishBuildArtifacts@1
          displayName: "Publicar JAR"
          inputs:
            PathtoPublish: 'springboot-backend/target/springboot-backend-0.0.1-SNAPSHOT.jar'
            ArtifactName: 'backend-jar'

    # -------- FRONTEND --------
    - job: BuildFrontend
      displayName: "Frontend React"
      steps:
        - checkout: self
        - task: NodeTool@0
          inputs:
            versionSpec: '$(nodeVersion)'

        - script: |
            cd react-frontend
            npm ci
            CI=true npm run test -- --watch=false --ci --runInBand --all --coverage --coverageReporters=cobertura
          displayName: "Tests frontend"

        - task: PublishCodeCoverageResults@2
          displayName: "Cobertura frontend (Jest)"
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/react-frontend/coverage/cobertura-coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/react-frontend/coverage'
            failIfCoverageEmpty: false

        # BUILD QA
        - script: |
            cd react-frontend
            REACT_APP_API_BASE=$(backendQaUrl) npm run build
            mkdir -p $(Build.ArtifactStagingDirectory)/front
            cd build
            zip -r $(Build.ArtifactStagingDirectory)/front/frontend-qa.zip .
          displayName: "Build frontend QA"

        # INTEGRATION TESTS (Cypress) contra build QA servido local
        - script: |
            cd react-frontend
            npx serve -s build -l 3000 >/tmp/serve.log 2>&1 &
            SERVE_PID=$!
            npx cypress run --browser chrome --config video=false,screenshotOnRunFailure=false --env frontBase=http://localhost:3000,apiBase=http://localhost:8080/api/v1/students --reporter junit --reporter-options "mochaFile=$(System.DefaultWorkingDirectory)/react-frontend/cypress/results/junit-[hash].xml,toConsole=true"
            kill $SERVE_PID
          displayName: "Tests de integracion (Cypress)"

        - task: PublishTestResults@2
          displayName: "Publicar resultados Cypress"
          inputs:
            testResultsFiles: '$(System.DefaultWorkingDirectory)/react-frontend/cypress/results/*.xml'
            testRunTitle: 'Cypress E2E'
            failTaskOnFailedTests: true

        # BUILD PROD
        - script: |
            cd react-frontend
            rm -rf build
            REACT_APP_API_BASE=$(backendProdUrl) npm run build
            cd build
            zip -r $(Build.ArtifactStagingDirectory)/front/frontend-prod.zip .
          displayName: "Build frontend Prod"

        - task: PublishBuildArtifacts@1
          displayName: "Publicar build QA"
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/front/frontend-qa.zip'
            ArtifactName: 'frontend-qa-build'

        - task: PublishBuildArtifacts@1
          displayName: "Publicar build Prod"
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/front/frontend-prod.zip'
            ArtifactName: 'frontend-prod-build'

# ===================================================
#   STAGE 2 - DEPLOY QA
# ===================================================
- stage: DeployQA
  displayName: "Deploy QA"
  dependsOn: BuildAndTest
  condition: succeeded()
  jobs:

    - job: DeployBackendQA
      displayName: "Backend QA"
      steps:
        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: current
            artifactName: backend-jar
            downloadPath: '$(Pipeline.Workspace)'

        - task: AzureWebApp@1
          displayName: "Deploy JAR QA"
          inputs:
            azureSubscription: '$(serviceConnection)'
            appName: '$(backendAppQa)'
            package: '$(Pipeline.Workspace)/backend-jar/springboot-backend-0.0.1-SNAPSHOT.jar'
            appSettings: |
              -PORT 8080

    - job: DeployFrontendQA
      displayName: "Frontend QA"
      steps:
        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: current
            artifactName: frontend-qa-build
            downloadPath: '$(Pipeline.Workspace)'

        - task: AzureWebApp@1
          displayName: "Deploy Frontend QA"
          inputs:
            azureSubscription: '$(serviceConnection)'
            appName: '$(frontendAppQa)'
            package: '$(Pipeline.Workspace)/frontend-qa-build/frontend-qa.zip'
            deploymentMethod: 'zipDeploy'

# ===================================================
#   STAGE 3 - APROBACION MANUAL
# ===================================================
- stage: ManualApproval
  displayName: "Aprobacion manual para Prod"
  dependsOn: DeployQA
  condition: succeeded()
  jobs:
    - job: WaitForApproval
      displayName: "Esperando aprobacion"
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: "Aprobar despliegue a Produccion."
            onTimeout: 'reject'
            timeout: '43200'

# ===================================================
#   STAGE 4 - DEPLOY PROD
# ===================================================
- stage: DeployProd
  displayName: "Deploy Produccion"
  dependsOn: ManualApproval
  condition: succeeded()
  jobs:

    - deployment: DeployBackendProd
      displayName: "Backend Prod"
      environment: 'Production'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@0
                inputs:
                  buildType: current
                  artifactName: backend-jar
                  downloadPath: '$(Pipeline.Workspace)'

              - task: AzureWebApp@1
                displayName: "Deploy JAR Prod"
                inputs:
                  azureSubscription: '$(serviceConnection)'
                  appName: '$(backendAppProd)'
                  package: '$(Pipeline.Workspace)/backend-jar/springboot-backend-0.0.1-SNAPSHOT.jar'
                  appSettings: |
                    -PORT 8080

    - deployment: DeployFrontendProd
      displayName: "Frontend Prod"
      environment: 'Production'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@0
                inputs:
                  buildType: current
                  artifactName: frontend-prod-build
                  downloadPath: '$(Pipeline.Workspace)'

              - task: AzureWebApp@1
                displayName: "Deploy Frontend Prod"
                inputs:
                  azureSubscription: '$(serviceConnection)'
                  appName: '$(frontendAppProd)'
                  package: '$(Pipeline.Workspace)/frontend-prod-build/frontend-prod.zip'
                  deploymentMethod: 'zipDeploy'
